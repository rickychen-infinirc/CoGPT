# 2025-08-16 系統修復更新日誌

## 問題描述
管理員權限系統存在硬編碼問題，導致非第一個admin用戶（user_id=1）無法正常使用知識庫功能，包括聊天權限錯誤、文件上傳失敗、前端顯示異常等問題。

## 修復範圍

### 1. 聊天系統權限修復
**文件：** `Controller/dashboard/chat_controller.py`

**問題：** 用戶角色ID獲取錯誤，取到密碼哈希值而非角色ID
```python
# 錯誤的代碼
user_role_id = user_data[0][2]  # 取到密碼哈希: $2b$12$Ks4c/K.UIyGh7K1/CKzUP...
```

**修復：** 新增智能角色ID識別函數
```python
def get_user_role_id(user_id: int) -> int:
    """安全地獲取用戶的角色ID"""
    try:
        user_data = user.get_user_by_id(user_id)
        user_record = user_data[0]
        
        # 遍歷所有字段找到角色ID（整數且不是用戶ID本身）
        for i, field in enumerate(user_record):
            if i == 0:  # 跳過用戶ID本身
                continue
            if isinstance(field, int) and field > 0 and field < 100:
                return field
        return None
    except Exception as e:
        return None
```

**權限檢查簡化：**
```python
def check_kb_access_permission(user_id: int, user_role_id: int, kb_id: int) -> bool:
    if is_admin:
        print("User is admin - granting access to all knowledge bases")
        return True  # 管理員可訪問所有知識庫
    else:
        # 非管理員檢查角色權限
        role_knowledge_bases = role_knowledge_base.get_knowledge_bases_by_user_id(user_id)
        return kb_id in role_knowledge_bases
```

### 2. RAG文件上傳修復
**文件：** `Service/upload_file.py`, `Model/UploadedFiles.py`, `Controller/dashboard/upload_file.py`

**問題：** async/await 語法衝突導致上傳失敗
```python
# Model/UploadedFiles.py - 錯誤的代碼
async def upload_file(self, user_id, filename, filepath):  # 不必要的async
    return self.sql_query(...)  # 返回整數，不是協程

# Controller - 錯誤的調用
file_id = await upload_file(user_id, file)  # await一個整數導致錯誤
```

**修復：** 移除不必要的async關鍵字
```python
# Model/UploadedFiles.py
def upload_file(self, user_id, filename, filepath):  # 移除async
    try:
        return self.sql_query('INSERT INTO uploaded_files...', (user_id, filename, filepath), True)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# Controller/dashboard/upload_file.py
file_id = upload_file(user_id, file)  # 移除await
```

**管理員存儲限制豁免：**
```python
def upload_file(user_id, file: UploadFile):
    # 檢查空間是否足夠 - 管理員用戶跳過檢查
    if setting.SPACE_PER_USER != -1 and not is_admin_user(user_id):
        # 普通用戶的存儲檢查邏輯
        if total_size+len(content) > setting.SPACE_PER_USER:
            raise Exception("space limit reached")
    elif is_admin_user(user_id):
        print(f"Admin user {user_id} - skipping storage limit check")
```

### 3. 知識庫文件管理權限修復
**文件：** `Controller/dashboard/knowledge_base_file.py`, `Model/KnowledgeBaseFile.py`

**問題：** 只有知識庫創建者才能上傳文件到該知識庫

**修復：** 允許所有管理員向任何知識庫添加文件
```python
# Model/KnowledgeBaseFile.py
def add_file_to_knowledge_base(self, user_id, knowledge_base_id, file_id):
    if is_admin:
        # 管理員可以添加任何文件到知識庫（跳過用戶ID檢查）
        return self.sql_query(f"""
        INSERT INTO knowledge_base_file (knowledge_base_id, file_id)
        SELECT kb.id, uf.id
        FROM knowledge_base kb
        CROSS JOIN uploaded_files uf
        WHERE kb.id = ? AND uf.id = ?
        """, (knowledge_base_id, file_id))
    else:
        # 非管理員使用原有邏輯（檢查文件擁有者）
        return self.sql_query(f"""
        INSERT INTO knowledge_base_file (knowledge_base_id, file_id)
        SELECT kb.id, uf.id FROM knowledge_base kb
        CROSS JOIN uploaded_files uf
        WHERE kb.id = ? AND kb.user_id = ? AND uf.user_id = ? AND uf.id = ?
        """, (knowledge_base_id, user_id, user_id, file_id))
```

### 4. 前端顯示修復
**文件：** `src/components/knowledgeBaseSetting.vue`, `src/components/basicSetting.vue`

**問題：** 知識庫切換時基本設定不更新

**修復：** 添加強制重新渲染和數據傳遞機制
```vue
<!-- knowledgeBaseSetting.vue -->
<basicSetting 
    :key="basicSettingKey" 
    :initial-data="currentKnowledgeBaseSettings"
    @update-settings="handleSettingsUpdate"
></basicSetting>

<script>
const basicSettingKey = ref(0); // 強制重新渲染
const currentKnowledgeBaseSettings = ref(null); // 存儲當前設定

watch(selectKnowledgeBase, async(newValue) => {
    if(newValue == 0) {
        currentKnowledgeBaseSettings.value = null;
    } else {
        await readData(newValue);
    }
    basicSettingKey.value++; // 強制重新渲染
})
</script>
```

```vue
<!-- basicSetting.vue -->
<script setup>
const props = defineProps({
    initialData: {
        type: Object,
        default: null
    }
});

// 監聽 initialData 的變化
watch(() => props.initialData, (newData) => {
    if (newData) {
        data.value = {
            id: newData.id || 0,
            name: newData.name || "新建知識庫",
            model: newData.model || 0,
            // ... 其他字段
        };
    }
}, { immediate: true, deep: true });
</script>
```

### 5. ESLint 配置修復
**文件：** `.eslintrc.js`

**修復：** 支持 Vue 3 Composition API
```javascript
module.exports = {
    env: {
        node: true,
        'vue/setup-compiler-macros': true
    },
    globals: {
        defineProps: 'readonly',
        defineEmits: 'readonly',
        defineExpose: 'readonly',
        withDefaults: 'readonly'
    },
    extends: [
        'plugin:vue/vue3-essential',
        'eslint:recommended'
    ]
}
```

## 測試驗證



### 日誌輸出確認：
```
User record for user 6: (6, 'rickychen', '密碼哈希...', 'email', 1, ...)
Found potential role_id at index 4: 1
User is admin - granting access to all knowledge bases
Admin user 1 - skipping storage limit check
Database save result: 67
```

