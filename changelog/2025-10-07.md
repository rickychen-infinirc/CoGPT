好的！我來撰寫一份完整的系統更新日誌。

---

# 2025-10-07 系統更新日誌

## 主要功能更新項目

### 1. 群組聊天討論積極度智能控制系統

**功能描述**：
實現基於任務上下文的 AI 積極度智能控制系統，讓 AI 能夠根據對話內容的相關性和學生程度，自動調整回應策略。

**更新內容**：

#### 1.1 討論積極度等級系統

實現五個積極度等級，對應不同的教學場景：

| 等級 | 名稱 | 行為描述 | 適用場景 |
|-----|------|---------|---------|
| 0 | 不主動回應 | 僅在直接提問時回答 | 自主學習環境 |
| 1 | 嚴重離題才回應 | 使用 LLM 判斷離題並糾正 | 需要專注討論的任務 |
| 2 | 熱衷者模式 | 提供深入技術分析 | 進階學習者 |
| 3 | 初學者模式 | 友善引導和基礎解釋 | 新手學習者 |
| 4 | 每句都回應 | 積極參與所有討論 | 高度互動課程 |

#### 1.2 離題檢測與糾正機制（等級 1）

**實現方式**：
- 使用 LLM 語義分析判斷訊息是否離題
- 結合任務描述和課程資訊進行上下文分析
- 自動提取任務關鍵字計算相關性

**工作流程**：
```
用戶訊息 → 獲取任務上下文 → LLM 離題判斷 → 決定是否回應
                ↓
         提取任務關鍵字
                ↓
         計算訊息相關性
                ↓
         構建糾正提示詞
```

**核心功能**：
```python
async def analyze_message_for_errors_enhanced(message_content, chat_history, task_context, course_context):
    """
    使用 LLM 分析訊息是否嚴重離題
    """
    # 構建任務和課程上下文
    context_str = f"""
    課程名稱：{course_context['name']}
    當前任務：{task_context['current_focus']['title']}
    任務描述：{task_context['current_focus']['description']}
    """
    
    # 使用 LLM 判斷
    analysis_prompt = f"""請分析以下學生訊息是否嚴重偏離課程主題...
    【課程/任務資訊】{context_str}
    【學生訊息】"{message_content}"
    請只回答「是」或「否」"""
    
    # 調用 LLM 並返回判斷結果
```

**測試案例**：
-  「晚餐吃甚麼」→ 判定離題，AI 糾正並引導回任務
-  「文明帝國可以學歷史」→ 判定相關，AI 不介入
-  「今天天氣真好」→ 判定離題，AI 糾正

#### 1.3 熱衷者模式（等級 2）

**觸發條件**：
- 訊息包含技術關鍵字（技術、原理、實現、算法等）
- 訊息長度超過 50 字
- 任務相關性 > 0.3

**回應特點**：
- 提供深入的技術細節和原理解析
- 使用專業術語和學術表達
- 引導深度思考和進階探索

**實現方式**：
```python
elif aggressiveness_level == 2:
    technical_indicators = ['技術', '原理', '實現', '算法', '架構', '設計']
    has_technical_content = any(indicator in message_content for indicator in technical_indicators)
    
    task_relevance = calculate_message_task_relevance(message_content, task_context)
    
    should_respond = (has_technical_content or 
                     len(message_content) > 50 or 
                     task_relevance > 0.3)
```

**測試案例**：
-  「文明帝國的科技樹如何設計」→ 提供專業的遊戲設計分析
-  「遊戲引擎的物理模擬原理」→ 詳細技術解釋
-  「晚餐吃甚麼」→ 不回應

#### 1.4 初學者模式（等級 3）

**觸發條件**：
- 訊息包含求助關鍵字（怎麼、如何、不懂、什麼等）
- 訊息包含問號
- 任務相關性 > 0.05
- 訊息長度 < 20 字（短問題通常是求助）

**回應特點**：
- 使用簡單易懂的語言
- 提供具體例子和步驟引導
- 鼓勵和友善的語氣

**實現方式**：
```python
elif aggressiveness_level == 3:
    learning_indicators = ['怎麼', '如何', '不懂', '學習', '什麼', '是什麼', 
                          '哪些', '為什麼', '幫我']
    is_learning_related = any(indicator in message_content for indicator in learning_indicators)
    has_question = '?' in message_content or '？' in message_content
    
    should_respond = (is_learning_related or 
                     has_question or 
                     task_relevance > 0.05 or 
                     len(message_content) < 20)
```

**測試案例**：
-  「文明帝國是什麼」→ 簡單介紹並舉例
-  「我不知道要選什麼遊戲」→ 友善引導並提供建議
-  「遊戲怎麼跟學科有關？」→ 通俗解釋並舉例
-  「晚餐吃甚麼」→ 不回應

#### 1.5 任務上下文整合

**實現功能**：
- 自動獲取群組對應的課程資訊
- 提取當前進行中的任務
- 從任務標題和描述中提取關鍵字
- 計算訊息與任務的語義相關性

**資料結構**：
```python
task_context = {
    'all_tasks': [...],           # 所有任務列表
    'active_tasks': [...],        # 進行中的任務
    'task_keywords': [...],       # 提取的關鍵字
    'current_focus': {            # 當前重點任務
        'id': 7,
        'title': '遊戲企劃-觀摩',
        'description': '在你曾經玩過的遊戲中...',
        'status': 1
    }
}
```

**關鍵字提取邏輯**：
```python
def extract_task_keywords(tasks: list) -> list:
    """從任務標題和描述中提取中文和英文關鍵字"""
    keywords = set()
    for task in tasks:
        title_words = re.findall(r'[\u4e00-\u9fff]+|[a-zA-Z]+', task['title'])
        keywords.update(title_words)
        
        if task['description']:
            desc_words = re.findall(r'[\u4e00-\u9fff]+|[a-zA-Z]+', task['description'])
            keywords.update(desc_words)
    
    return list(keywords)
```

#### 1.6 System Prompt 優化

**修改前的問題**：
- System Prompt 指示「直接回覆問題」，導致 AI 忽略觸發提示詞
- 沒有明確的優先級指示

**修改後的 System Prompt**：
```
你是一位教學助理，負責協助學生完成課程任務。

重要規則：
1. 如果收到特別指示要求糾正學生，你必須優先執行這些指示
2. 只有在沒有特別指示時，才回答學生的問題
3. 參考已知資訊回答，若已知資訊為空則使用你的知識
4. 使用繁體中文回覆
```

**觸發提示詞整合方式**：
```python
# 將觸發提示詞放在最前面，確保優先級
if system_prompt and system_prompt.strip():
    use_system_prompt = f"{system_prompt}\n\n原本的系統提示：{KnowledgeBaseSetting['system_prompt']}"
else:
    use_system_prompt = KnowledgeBaseSetting["system_prompt"]
```

#### 1.7 強化觸發提示詞（等級 1）

**最終版本**：
```
 緊急糾正 - 學生離題了！

學生剛才說：「{message_content}」

這個訊息與課程主題完全無關！

當前課程主題：{course_name}
當前任務：{task_title}
任務要求：{task_description}

你必須這樣回應：
1. 第一句話明確告訴學生：「你的問題與當前課程主題無關」
2. 告訴學生當前應該討論的任務是什麼
3. 引導學生回到課程主題
4. 絕對不要回答「{message_content}」這個離題問題

開始回應：
```

**實際效果**：
```
學生：晚餐吃甚麼

AI 回應：
同學，你的問題與當前課程主題無關。

當前任務：遊戲企劃-觀摩
任務要求：在你曾經玩過(或聽過)的遊戲中，你覺得有哪個遊戲是你在遊戲時可以學習到學科知識，舉3個例子，並具體說明遊戲中的那些設定與哪個學科知識有關。

請回到課程主題進行討論，分享你對遊戲中學科知識的觀察。
```

---

### 2. 前端知識庫設定介面優化

#### 2.1 討論積極度設定區塊

**新增功能**：
- 積極度滑桿（0-4 等級）
- 即時說明文字顯示
- 觸發提示詞編輯區
- 自動載入預設提示詞

**UI 實現**：
```vue
<div class="mt-4 p-4 bg-gray-50 rounded-lg border">
    <div class="text-lg font-semibold text-gray-700 mb-4">討論積極度設定</div>
    
    <!-- 積極度滑桿 -->
    <input type="range" min="0" max="4" step="1" v-model="data.discussion_aggressiveness_level">
    
    <!-- 說明文字 -->
    <div class="mt-2 p-2 bg-blue-50 rounded text-sm">
        {{ getAggressivenessDescription(data.discussion_aggressiveness_level) }}
    </div>
    
    <!-- 觸發提示詞編輯器 -->
    <textarea v-model="data.aggressiveness_trigger_prompt" 
              :placeholder="getDefaultPromptPlaceholder(data.discussion_aggressiveness_level)">
    </textarea>
</div>
```

#### 2.2 自動更新機制

**實現方式**：
```javascript
// 監聽積極度變化，自動更新提示詞
watch(() => data.value.discussion_aggressiveness_level, (newLevel) => {
    if (newLevel >= 1 && newLevel <= 3) {
        const defaultPrompts = {
            1: "你必須立即提醒學生：他們的討論已經偏離課程主題...",
            2: "以適合有經驗用戶的方式回應，提供深入的技術細節...",
            3: "以適合初學者的方式回應，使用簡單易懂的語言..."
        };
        data.value.aggressiveness_trigger_prompt = defaultPrompts[newLevel] || "";
    } else {
        data.value.aggressiveness_trigger_prompt = "";
    }
});
```

---

## 修改的文件

### 後端文件

1. **Service/llm.py**
   - 新增 `get_task_context()` - 獲取任務上下文
   - 新增 `get_course_context()` - 獲取課程上下文
   - 新增 `analyze_message_for_errors_enhanced()` - LLM 離題判斷
   - 新增 `analyze_with_rules()` - 規則備用判斷
   - 新增 `calculate_message_task_relevance()` - 任務相關性計算
   - 新增 `calculate_message_course_relevance()` - 課程相關性計算
   - 新增 `extract_task_keywords()` - 關鍵字提取
   - 修改 `should_ai_respond()` - 整合積極度判斷邏輯
   - 修改 `handle_text_model()` - 優化 system prompt 組合

2. **Model/KnowledgeBase.py**
   - 新增 `discussion_aggressiveness_level` 欄位
   - 新增 `aggressiveness_trigger_prompt` 欄位
   - 修改 `get_setting()` - 返回積極度設定

3. **Controller/dashboard/knowledge_base.py**
   - 修改 `update_knowledge_base()` - 支援積極度欄位更新
   - 修改 `create_knowledge_base()` - 初始化積極度預設值

### 前端文件

1. **src/components/basicSetting.vue**
   - 新增討論積極度設定區塊
   - 新增 `getAggressivenessDescription()` - 獲取說明文字
   - 新增 `getDefaultPromptPlaceholder()` - 獲取預設提示詞
   - 新增積極度變化監聽器
   - 優化表單資料結構

---

## 資料庫變更

### knowledge_base 表新增欄位

```sql
ALTER TABLE knowledge_base ADD COLUMN discussion_aggressiveness_level INTEGER DEFAULT 1;
ALTER TABLE knowledge_base ADD COLUMN aggressiveness_trigger_prompt TEXT DEFAULT '';
```

**欄位說明**：
- `discussion_aggressiveness_level`: 積極度等級 (0-4)
- `aggressiveness_trigger_prompt`: 觸發提示詞內容

---

## 核心演算法

### 離題判斷流程

```
接收訊息
    ↓
獲取任務上下文 ← 查詢 group_tasks 表
    ↓
提取任務關鍵字 ← 正則表達式分詞
    ↓
構建 LLM 分析提示 ← 包含任務描述
    ↓
調用 LLM 判斷 ← temperature=0 確保穩定
    ↓
解析結果（是/否）
    ↓
    是 → 構建糾正提示詞 → 強制插入 system prompt 最前方
    否 → 不回應
```

### 相關性計算公式

```python
# 基礎相關性
relevance = matches / len(message_words)

# 如果提到當前任務，加權
if mentions_current_task:
    relevance += 0.3

# 最終相關性（上限 1.0）
final_relevance = min(relevance, 1.0)
```

### 積極度判斷決策樹

```
等級 0: 
    - 包含直接提問指標？ → 是 → 回應
    - 否 → 不回應

等級 1:
    - LLM 判斷離題？ → 是 → 糾正並回應
    - 否 → 不回應

等級 2:
    - 包含技術關鍵字？ → 是 → 回應
    - 訊息長度 > 50？ → 是 → 回應
    - 任務相關性 > 0.3？ → 是 → 回應
    - 否 → 不回應

等級 3:
    - 包含學習關鍵字？ → 是 → 回應
    - 包含問號？ → 是 → 回應
    - 任務相關性 > 0.05？ → 是 → 回應
    - 訊息長度 < 20？ → 是 → 回應
    - 否 → 不回應

等級 4:
    - 總是回應
```

