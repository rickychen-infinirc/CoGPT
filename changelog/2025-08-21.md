# 2025-08-21 系統更新日誌

## 主要修復項目

### 圖片生成功能修復
**問題描述**：群組對話中使用知識庫圖片生成功能時出現多個問題
- 資料庫外鍵約束錯誤 (`FOREIGN KEY constraint failed`)
- 資料庫鎖定問題 (`database is locked`)
- 圖片路徑處理錯誤導致前端無法正常顯示
- 前端JSON解析錯誤 (`Unexpected token '!' in JSON`)

**解決方案**：
1. **修復資料庫約束問題**
   - 移除群組聊天中錯誤調用的 `personalConversation.add_message()` 函數
   - 群組聊天與個人聊天使用不同的存儲邏輯

2. **修復圖片路徑處理**
   - 統一路徑分隔符處理（Windows `\` vs Unix `/`）
   - 修改為返回 Markdown 格式的圖片連結而非 base64 數據

3. **修復前端JSON解析錯誤**
   - 在 `handleWebSocketMessage` 函數中添加 Markdown 圖片格式檢測
   - 避免對 `![Generated Image](...)` 格式執行 JSON 解析

### DALL-E 功能增強
**新增功能**：在前端顯示 DALL-E 修改後的提示詞

**實現細節**：
- 在 `dalle_api.py` 中新增 `generate_image_with_details()` 方法
- 返回詳細資訊包括原始圖片路徑和 DALL-E 修改後的提示詞
- 修改 `handle_kb_image_generation()` 函數以支持顯示修改後提示詞

## 修改的文件

### 後端文件
1. **Service/llm.py**
   - `handle_kb_image_generation()` 函數：移除資料庫存儲邏輯，修改圖片返回格式
   - `chat_knowledge_base_new()` 函數：更新圖片生成調用邏輯

2. **Service/draw/dalle_api.py**
   - 新增 `generate_image_with_details()` 方法
   - 支持返回 DALL-E 修改後的提示詞資訊

3. **database.py**
   - 資料庫結構更新，確保外鍵約束正確配置

### 前端文件
1. **src/components/chatWindow/chatWindow.vue**
   - `handleWebSocketMessage()` 函數：新增 Markdown 圖片格式檢測
   - 防止對圖片連結執行 JSON 解析



## 測試結果



### 驗證項目
- [x] 群組聊天圖片生成
- [x] 個人聊天圖片生成  
- [x] 圖片路徑正確處理
- [x] 前端圖片正常顯示
- [x] 資料庫操作無錯誤
- [x] DALL-E 提示詞顯示



### 路徑處理標準化
```python
# 統一路徑分隔符處理
actual_path = path.replace("\\", "/")
if actual_path.startswith("/"):
    actual_path = actual_path[1:]
```

### 前端消息處理優化
```javascript
// 檢測 Markdown 圖片格式，避免 JSON 解析
if (data.startsWith('![Generated Image](') && data.includes('/api/images/')) {
    // 直接處理為 Markdown，不執行 JSON 解析
}
```

