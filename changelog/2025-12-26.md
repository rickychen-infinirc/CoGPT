# 2025-12-26 Changelog

重構 AI 專家的「討論積極度」邏輯，明確區分「主動回應」與「被動回應」兩種模式。

---

## 核心邏輯變更

### 新增概念：主動回應 vs 被動回應

| 類型 | 定義 | 積極度影響 |
|------|------|-----------|
| **被動回應** | 用戶明確選擇/點名某個 AI 專家 | 無論積極度設定為何，必定回應 |
| **主動回應** | AI 專家自行判斷是否參與討論 | 根據積極度等級 0-4 決定 |

### 積極度等級行為定義

| 等級 | 名稱 | 主動回應行為 | 被動回應 |
|------|------|-------------|---------|
| 0 | 不主動回應 | 永不主動回應 | 必定回應 |
| 1 | 嚴重問題才回應 | 偵測到嚴重離題或錯誤時主動介入 | 必定回應 |
| 2 | 熱衷者模式 | 與任務相關且有技術深度時主動回應 | 必定回應 |
| 3 | 初學者模式 | 與任務相關（寬鬆判斷）時主動回應 | 必定回應 |
| 4 | 全部回應 | 每句話都主動回應 | 必定回應 |

### 多 AI 對話室模式邏輯

當用戶在對話室中選擇某個 AI 專家發送訊息時：
- **被選中的 AI 專家**：走被動回應路線，必定回應
- **其他可用的 AI 專家**：根據各自的積極度設定決定是否主動回應

---

## API 變更

### `should_ai_respond` 函數

新增參數：
```python
is_explicitly_selected: bool = False  # 是否被用戶明確選擇
```

### `should_multiple_ai_respond` 函數

新增參數：
```python
selected_kb_id: int = None  # 用戶明確選擇的知識庫 ID
```

---

## 修改檔案清單

```
Service/llm.py
Controller/dashboard/chat_controller.py
```

---

## 詳細修改內容

### 1. Service/llm.py

**修改函數：`should_ai_respond`**
- 新增 `is_explicitly_selected` 參數
- 當 `is_explicitly_selected=True` 時，跳過積極度判斷，直接回應
- 當 `is_explicitly_selected=False` 時，根據積極度等級判斷是否主動回應

**修改函數：`should_multiple_ai_respond`**
- 新增 `selected_kb_id` 參數
- 對每個知識庫判斷是否為用戶選擇的目標
- 被選中的知識庫傳入 `is_explicitly_selected=True`
- 其他知識庫傳入 `is_explicitly_selected=False`

**修改函數：`chat_knowledge_base_new`**
- 調用 `should_ai_respond` 時傳入 `is_explicitly_selected=True`

### 2. Controller/dashboard/chat_controller.py

**修改函數：`handle_group_chatroom_chat`**
- 獲取用戶選擇的知識庫 ID
- 調用 `should_multiple_ai_respond` 時傳入 `selected_kb_id` 參數

**修改函數：`handle_group_chat`**
- 調用 `should_ai_respond` 時傳入 `is_explicitly_selected=True`

---
