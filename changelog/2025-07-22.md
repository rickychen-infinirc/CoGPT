# 2025-07-22 系統修改記錄

## 問題描述
管理員權限系統存在硬編碼問題，導致非 `user_id=1` 但具有管理員角色的用戶無法正常訪問和使用知識庫功能。

**具體問題：**
- 用戶 rickychen (`user_id=6`, `role_id=1`) 無法看到 admin (`user_id=1`) 創建的知識庫
- 系統硬編碼 `user_id=1` 作為管理員判斷條件
- 只有第一個創建的管理員能正常使用管理員功能

## 修改文件

### 1. `Controller/dashboard/role_knowledge_base_controller.py`

**問題位置：**
- 第20行：`if role_id == 1` (硬編碼角色ID)
- 第35行：`knowledgeBase.get_knowledge_bases_by_user_id(1)` (硬編碼用戶ID)

**修改內容：**

#### 新增輔助函數
```python
def is_admin_role(role_id: int) -> bool:
    """檢查給定的角色ID是否為管理員角色"""
    
def get_admin_users():
    """獲取所有管理員用戶的ID列表"""
    
def get_all_admin_knowledge_bases_data():
    """獲取所有管理員的知識庫數據"""
```

#### 修改邏輯
- 將 `if role_id == 1` 改為 `if is_admin_role(role_id)`
- 動態查找所有具有 "Admin" 角色的用戶
- 合併所有管理員用戶的知識庫（去重處理）
- 添加調試日誌和錯誤處理

### 2. `Controller/dashboard/knowledge_base.py`

**問題位置：**
- `/api/knowledge_base` 端點只顯示當前用戶的知識庫
- 其他 CRUD 操作缺乏管理員權限支持

**修改內容：**

#### 新增輔助函數
```python
def is_admin_user(user_role_id: int) -> bool:
    """檢查用戶是否為管理員"""
    
def get_admin_users_list():
    """獲取所有管理員用戶的ID列表"""
    
def get_all_admin_knowledge_bases():
    """獲取所有管理員的知識庫"""
```

#### 修改端點邏輯

**GET `/api/knowledge_base`**
- **管理員**：顯示所有管理員創建的知識庫
- **普通用戶**：只顯示自己創建的知識庫

**GET `/api/knowledge_base/{id}`**
- 管理員可以查看任何知識庫的詳細設置

**PUT `/api/knowledge_base/{id}`**
- 管理員可以編輯任何知識庫

**DELETE `/api/knowledge_base/{id}`**
- 管理員可以刪除任何知識庫

**POST `/api/knowledge_base/{id}/upload`**
- 管理員可以為任何知識庫上傳頭像

## 修改結果驗證

### 日誌輸出確認
```
Getting all admin knowledge bases...
Admin role ID: 1
Found admin users: [1, 5, 6]  // 找到3個管理員用戶
Getting knowledge bases for user 1
Found 12 knowledge bases for user 1  // user_id=1 有12個知識庫
Getting knowledge bases for user 5
Found 0 knowledge bases for user 5   // user_id=5 沒有知識庫
Getting knowledge bases for user 6
Found 0 knowledge bases for user 6   // user_id=6 沒有知識庫
Total unique admin knowledge bases: 12
```



## 部署步驟

替換整的Controller\dashboard文件夾


