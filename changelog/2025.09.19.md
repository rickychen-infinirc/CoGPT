# 2025-09-19 系統更新日誌

## 主要修復項目

### ComfyUI 工作流模板路徑配置優化

**問題描述**：
ComfyUI API 在不同位置的檔案中硬編碼了工作流模板路徑，導致檔案放置位置不靈活且容易出錯。
* `Service/draw/comfyui_api.py` 和 `Controller/comfyui_api.py` 都需要載入 `Game.json`
* 路徑寫死在程式碼中，難以維護和修改
* 當檔案位置改變時需要修改多個檔案
* 不符合配置外部化的最佳實踐

**解決方案**：
1. **環境變數統一管理**
   * 在 `.env` 中新增 `COMFYUI_WORKFLOW_PATH` 配置項
   * 支援相對路徑和絕對路徑設定
2. **程式碼重構**
   * 兩個 API 檔案都改為從環境變數讀取路徑
   * 加入路徑標準化處理，確保跨平台相容性
   * 提供預設值作為後備選項

---

## 修改的文件

### 配置文件
1. **.env**
   * 新增 `COMFYUI_WORKFLOW_PATH=draw/Game.json` 配置項

### 後端文件
1. **Service/draw/comfyui_api.py**
   * `load_workflow_template()`：改為從環境變數讀取路徑
   * 加入 `dotenv` 載入和路徑處理邏輯

2. **Controller/comfyui_api.py**
   * `load_workflow_template()`：改為從環境變數讀取路徑
   * 統一路徑處理方式

---

### 環境變數配置
```env
# ComfyUI 工作流模板路徑
COMFYUI_WORKFLOW_PATH=draw/Game.json
```

### 程式碼修復片段

**Service/draw/comfyui_api.py**：
```python
import os
from dotenv import load_dotenv

load_dotenv()

def load_workflow_template(self):
    """載入工作流模板"""
    template_path = os.getenv('COMFYUI_WORKFLOW_PATH', 'draw/Game.json')
    
    if not os.path.isabs(template_path):
        project_root = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))
        template_path = os.path.join(project_root, template_path)
    
    template_path = os.path.normpath(template_path)
    print(f"正在載入模板: {template_path}")
    
    with open(template_path, 'r', encoding='utf-8') as f:
        return json.load(f)
```

**Controller/comfyui_api.py**：
```python
import os
from dotenv import load_dotenv

load_dotenv()

def load_workflow_template(self):
    template_path = os.getenv('COMFYUI_WORKFLOW_PATH', 'draw/Game.json')
    
    if not os.path.isabs(template_path):
        template_path = os.path.join(os.getcwd(), template_path)
    
    template_path = os.path.normpath(template_path)
    print(f"load template: {template_path}")
    
    with open(template_path, 'r', encoding='utf-8') as f:
        return json.load(f)
```
