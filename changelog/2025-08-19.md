# 2025-08-19 系統修復更新日誌

## 問題描述
群組聊天系統存在多項問題，包括圖片生成失敗、資料庫約束錯誤、群組對話需要@AI才能觸發回應、以及前端流式更新不一致等問題。

## 修復範圍

### 1. 資料庫結構統一修復
**文件：** `Model/KnowledgeBase.py`, `database.py`

**問題：** 循環導入和字段名稱不一致導致系統啟動失敗
```python
# 錯誤的循環導入
from Model.KnowledgeBase import knowledgeBase  # 第5行導入自己
```

**修復：** 移除循環導入，統一字段命名
```python
# Model/KnowledgeBase.py - 正確的結構
from Model.BaseModel import BaseModel
from Model.Setting import Setting

class KnowledgeBase(BaseModel):
    def __init__(self):
        self.fields = ['id', 'user_id', 'name', 'model', 'temperature', 
                      'score_threshold', 'search_item_limit', 'system_prompt', 
                      'description', 'avatar_path', 'model_type', 
                      'selected_image_model', 'use_frontend_prompt']
        self.table = 'knowledge_base'

# 文件末尾創建實例
knowledgeBase = KnowledgeBase()
```

**資料庫表結構統一：**
```python
# database.py - 確保表名一致
def update_database_schema(self):
    cursor.execute("PRAGMA table_info(knowledge_base)")  # 單數形式
    
    if 'selected_image_model' not in columns:
        cursor.execute("ALTER TABLE knowledge_base ADD COLUMN selected_image_model TEXT")
```

### 2. 圖片生成路徑修復
**文件：** `Service/llm.py`, `Service/draw/dalle_api.py`

**問題：** Windows/Unix 路徑格式不一致導致圖片讀取失敗
```python
# 保存路徑: static/generated_images\dalle_1755574969452.png (反斜線)
# 讀取路徑: /static/generated_images/dalle_1755574969452.png (正斜線)
```

**修復：** 統一路徑處理和錯誤處理
```python
# Service/llm.py - handle_kb_image_generation 函數
for path in image_paths:
    try:
        # 處理路徑格式，確保使用正確的分隔符
        if path.startswith('/'):
            file_path = path[1:]  # 移除開頭的 /
        else:
            file_path = path
        
        normalized_path = file_path.replace('\\', '/')
        
        if os.path.exists(normalized_path):
            with open(normalized_path, "rb") as img_file:
                img_data = img_file.read()
                yield json.dumps({"img": img_data.hex(), "filetype": "png"})

# 資料庫錯誤處理 - 不影響圖片顯示
try:
    result = "\n".join([f"![Generated Image](/api/images/{os.path.basename(path)}" for path in image_paths])
    personalConversation.add_message(chat_room_id, 'bot', result, model_name, None)
except Exception as db_error:
    print(f"保存聊天記錄失敗: {db_error}")
    # 不讓資料庫錯誤影響圖片顯示
```

### 3. 群組聊天自動回應修復
**文件：** `Controller/dashboard/chat_controller.py`

**問題：** 群組聊天需要 @AI 才會觸發回應，與個人聊天行為不一致

**修復：** 移除強制 @AI 檢查條件
```python
# 原來的條件檢查
if message_data.talk_with_ai and message_data.use_kb and message_data.kb_id:

# 修改為自動回應
if message_data.use_kb and message_data.kb_id:
```

**流式更新優化：**
```python
# 添加節流控制避免前端阻塞
last_broadcast_time = 0
broadcast_interval = 0.2  # 200ms 間隔

async for chunk in chat_knowledge_base_new(group_id, message_data.message, history, message_data.kb_id):
    if chunk not in ["<#END#>", "<#IMAGE_END#>", "<#TEXT_END#>"]:
        response += chunk
        
        current_time = time.time()
        if current_time - last_broadcast_time >= broadcast_interval:
            await chat_manager.broadcast(
                f"group_{group_id}",
                json.dumps({
                    "id": bot_message_id,
                    "sender_role": "bot",
                    "message": response,
                    "mode": "update"  # 統一使用 "update"
                })
            )
            last_broadcast_time = current_time
```

### 4. 前端響應狀態同步修復
**文件：** `src/views/TeamChatView.vue`

**問題：** 非@AI觸發的回應不顯示流式更新，需要重新整理才能看到結果

**修復：** 統一響應狀態設置邏輯
```javascript
// 原來只有 @AI 才設置響應狀態
if (mentionType === 'AI' || mentionType === true) {
    responsing.value = true;
}

// 修改為知識庫回應都設置響應狀態
if (mentionType === 'AI' || mentionType === true || selected_LLM_or_KB.value.is_kb) {
    responsing.value = true;
    responsingChatRoomId.value = selectedChatRoomId.value;
}

// talk_with_ai 邏輯同步修改
talk_with_ai: mentionType === 'AI' || mentionType === true || selected_LLM_or_KB.value.is_kb
```

**消息處理優化：**
```javascript
const processChatMessage = (messageData) => {
    // 使用 requestAnimationFrame 優化 DOM 更新
    requestAnimationFrame(() => {
        if (messageData.mode === 'update' || messageData.mode === 'stream_update' || messageData.mode === 'final_update') {
            // 統一處理所有更新類型
            const messageIndex = chatHistory.value[selectedChatRoomId.value]
                .findIndex(msg => msg.id === messageData.id);
            if (messageIndex !== -1) {
                Object.assign(chatHistory.value[selectedChatRoomId.value][messageIndex], {
                    message: messageData.message,
                    llm_kb_name: messageData.llm_kb_name || '',
                    source_documents: messageData.source_documents || null
                });
            }
        }
    });
};
```

### 5. 知識庫模型配置統一
**文件：** `Controller/dashboard/knowledge_base.py`, `src/components/basicSetting.vue`

**修復：** 統一前後端字段命名
```python
# 後端統一使用 selected_image_model
class KnowledgeBaseData(BaseModel):
    selected_image_model: str = ""  # 統一字段名

result = {
    "selected_image_model": response.get('selected_image_model', '')
}
```

```vue
<!-- 前端同步使用相同字段名 -->
<script>
const data = ref({
    selected_image_model: ""  // 與後端保持一致
});

watch(() => props.initialData, (newData) => {
    if (newData) {
        data.value = {
            selected_image_model: newData.selected_image_model || ""
        };
    }
});
</script>
```

## 測試驗證

### 功能測試確認：
- 群組聊天無需 @AI 即可自動回應
- 圖片生成成功並正確顯示
- 流式更新正常顯示，無需重新整理
- 資料庫約束錯誤已解決

### 日誌輸出確認：
```
獲得 DALL-E 圖片 URL: https://oaidalleapiprodscus.blob.core.windows.net/...
圖片已保存到: static/generated_images\dalle_1755574969452.png
圖片生成完成!
群組消息已發送: {"chat_type": "group", "talk_with_ai": true, "use_kb": true}
```

